---
title: "Virtuso on GCP: Faster with Container-Optimised OS"
emoji: "ğŸš¢"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Virtuoso", "GCP", "LOD", "SPARQL"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ [Linked Open Data Challenge 2021 (LOD ãƒãƒ£ãƒ¬ãƒ³ã‚¸ 2021)](https://2021.lodc.jp/entry.html) ã® **ãƒ‡ãƒ¼ã‚¿æ´»ç”¨éƒ¨é–€** ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ã¦ã„ã¾ã™
:::

# ã¯ã˜ã‚ã«

è‡ªå‰ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å»ºã¦ã‚ˆã†ï¼ã¨è€ƒãˆãŸã¨ãã«ï¼Œ**æ„å¤–ã¨é›£ã—ã„ã—æ‰‹é–“ãŒã‹ã‹ã‚‹ã¨ã„ã†å•é¡Œ**ãŒã‚ã‚Šã¾ã™ï¼ã“ã‚Œã‚’è§£æ±ºã—ã‚ˆã†ã¨å–ã‚Šçµ„ã‚“ã ã®ãŒ [æ— æ­£æ´‹ã•ã‚“ï¼ˆå…¬å…±ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿åˆ©æ´»ç”¨ç ”ç©¶å®¤ mirkoï¼‰](http://www.mirko.jp/) ã® "[Google Cloud Platform ã®ç„¡æœŸé™ç„¡æ–™æ ã‚’åˆ©ç”¨ã—ãŸ Virtuoso ã®æ§‹ç¯‰æ–¹æ³• - Qiita](https://megalodon.jp/2021-1214-2256-07/https://qiita.com:443/mirkohm/items/30991fec120541888acd)" ã§ã—ãŸ[^1]ï¼

[^1]: [LOD ãƒãƒ£ãƒ¬ãƒ³ã‚¸ 2020 å¹´åº¦å—è³ä½œå“ï¼ˆLOD ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è³ï¼‰](https://2020.lodc.jp/awardSymposium2020Report.html#:~:text=%E3%81%AF%E3%81%98%E3%82%81%E3%82%8B%EF%BC%81%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%BB%E3%83%83%E3%83%88-,%E3%83%86%E3%83%BC%E3%83%9E%E8%B3%9E%EF%BC%9A%20LOD%E3%83%97%E3%83%AD%E3%83%A2%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%B3%9E,-%E4%BD%9C%E5%93%81%E5%90%8D)ã§ã‚‚ã‚ã‚‹

https://qiita.com/mirkohm/items/30991fec120541888acd
https://qiita.com/mirkohm/items/95cac0ab26007f8bade4

ã—ã‹ã—ï¼Œã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯ã„ãã¤ã‹ã®æ¬ ç‚¹ãŒã‚ã‚Šï¼Œãã®ã›ã„ã§å®Ÿéš›ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å»ºã¦ã‚‹ã¾ã§ã«ã¯é«˜ã„ãƒãƒ¼ãƒ‰ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã‚ˆã†ã«ç§ã¯æ„Ÿã˜ã¾ã—ãŸ ğŸ˜¢
æœ¬è¨˜äº‹ã§ã¯ï¼Œã“ã‚Œã‚‰ã‚’å…‹æœã—ï¼Œã‚ˆã‚Šç°¡å˜ã« SPARQL ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å»ºã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ãªæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ï¼

# å…ˆè¡Œäº‹ä¾‹ã®æ¬ ç‚¹

ã•ã¦ï¼Œã¾ãšå…ˆè¿°ã—ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯äºŒã¤ã®æ¬ ç‚¹ã¨ä¸€ã¤ã®å¤§ããªèª¤ã‚ŠãŒã‚ã‚Šã¾ã™ï¼š

æ¬ ç‚¹ï¼š

1. Openlink Virtuoso ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«æ»…èŒ¶è‹¦èŒ¶ãªæ™‚é–“ãŒã‹ã‹ã‚‹
2. å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã«ç ´èŒ¶æ»…èŒ¶ãªæ™‚é–“ãŒã‹ã‹ã‚‹

èª¤ã‚Šï¼š

- ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å¿—ã™äººã¯ï¼Œå½“ç„¶ã‚µãƒ¼ãƒé–¢é€£çŸ¥è­˜ã‚‚ç†ŸçŸ¥ã—ã¦ã„ã‚‹ã®ã§ï¼Œ**ã‚³ãƒãƒ³ãƒ‰ãŒãŸãã•ã‚“å‡ºã¦ãã¦ã‚‚å¤§ä¸ˆå¤«**

:::details è©³ç´°ãªèª¬æ˜

## æ¬ ç‚¹ â‘ ï¼šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§æ™‚é–“ã‚’æµªè²»ã—ãŒã¡

- ãŸã ã§ã•ãˆæ™‚é–“ãŒã‹ã‹ã‚‹ `make` ã‚³ãƒãƒ³ãƒ‰ã‚’[ã‚ã–ã‚ã–è²§å¼±ãªè¨ˆç®—æ©Ÿã«ã‚„ã‚‰ã›ã¦ã„ã‚‹](https://qiita.com/mirkohm/items/30991fec120541888ac#virtuoso-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)ãŸã‚ï¼Œç„¡é§„ã«æ™‚é–“ã‚’æ¶ˆè²»ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹

ã‚½ãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰ã§ã¯ãªãï¼Œæ—¢å­˜ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾æµç”¨ã—ãŸã»ã†ãŒè‰¯ã„ã¯ãšã€€ â†’ ã€€**Docker ã‚’æ´»ç”¨**ã—ã‚ˆã†ï¼

## æ¬ ç‚¹ â‘¡ï¼šãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã§æ™‚é–“ã‚’æµªè²»ã—ãŒã¡

- æ•° KB ç¨‹åº¦ã®ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½“ãªã‚‰ã„ã–ã—ã‚‰ãšï¼Œæ•° MB ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚‰è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦ Bulk load ã—ãŸã„ã¨æ€ã£ãŸã¨ãã«ï¼Œãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«ã‚ã¡ã‚ƒãã¡ã‚ƒæ™‚é–“ãŒã‹ã‹ã‚‹ or å¤±æ•—ã—ã¦èµ·å‹•ã—ãªããªã‚‹

ã“ã‚Œã‚‚ã¾ãŸï¼Œã‚ã–ã‚ã–è²§å¼±ãªè¨ˆç®—æ©Ÿã§ï¼ˆï½’ï½™
GCP ã® Always Free ã‚’ä½¿ã„ãŸã„å ´åˆã«ã¯ï¼Œè²§å¼±ãªè¨ˆç®—è³‡æºã§è³„ã†ã®ã‚‚è‡´ã—æ–¹ãªã„â€¦â€¦ã¨æ€ã£ãŸã®ã‚‚ã¤ã‹ã®é–“ï¼Œ**ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚„ã£ã¦ãŠã‘ã°ã‚ˆã„**ã“ã¨ã«æ°—ã¥ãï¼Œ**[GCS](https://cloud.google.com/storage) ã‚‚æ´»ç”¨**ã™ã‚‹ã“ã¨ã«ã—ãŸï¼

## èª¤ã‚Šï¼šã‚³ãƒãƒ³ãƒ‰ãŒãŸãã•ã‚“å‡ºã¦ãã¦ã‚‚å¤§ä¸ˆå¤«

ãã‚‚ãã‚‚ï¼Œå¤šãã®äººã«ã¨ã£ã¦ã¯

ï¼¿äººäººäººäººäººäººäººäººäººäººäººäººäººäººï¼¿
ï¼ã€€ã‚µãƒ¼ãƒç’°å¢ƒã«è§¦ã‚ŒãŸããªã„ã€€ï¼œ
ï¿£ Y^Y^Y^Y^Y^Y^Y^Y^Y^Y ï¿£

ã¨ã„ã†ã®ãŒæœ¬éŸ³ã§ã‚ã‚ã†ã¨æ€ã‚ã‚Œã‚‹ï¼
ã‚ˆãã‚ã‹ã‚‰ãªã„ã‚³ãƒãƒ³ãƒ‰ãŒä¸¦ã‚“ã§ã„ã‚‹ã ã‘ã§ã‚‚ï¼Œã‹ãªã‚Šã‚¦ãƒƒã¨ãªã‚‹ã‚‰ã—ã„ï¼

ã›ã‚ã¦**æœ€å°é™ã®ã‚³ãƒãƒ³ãƒ‰**ã§ï¼Œã—ã‹ã‚‚**ã‚³ãƒ”ãƒšã§ã™ã¹ã¦çµ‚ãˆã‚‰ã‚ŒãŸã‚‰å¬‰ã—ã„**ã¨è€ƒãˆãŸï¼

:::

![æ™‚é–“ãŒéãã¦ã„ã‚‹ã“ã¨ã«ç„¦ã‚‹å¥³æ€§ã¨ã€é£›ã‚“ã§ã„ãæ™‚é–“ã®ã‚¤ãƒ©ã‚¹ãƒˆ](https://4.bp.blogspot.com/-W3tg5MElxmQ/WzC9on89vDI/AAAAAAABM6c/R_4K4tzlE1U7f9sfPjiG5OY52PzNjfs6QCLcBGAs/s800/jikan_tobu_woman.png =200x)
_*Time flies like an arrow*_

ã“ã‚Œã‚‰ã®å•é¡Œã¯ **Docker ãŠã‚ˆã³ GCS[^2] ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§è§£æ±º**ã§ãã¾ã™ï¼

[^2]: [Google Cloud Storage](https://cloud.google.com/storage) ã®ã“ã¨ï¼ˆè©³ç´°ã¯ãƒªãƒ³ã‚¯å…ˆã‚’å‚ç…§ï¼‰

ä»¥ä¸‹ã§ã¯ï¼Œãã®æ–¹æ³•ã«ã¤ã„ã¦ç´°ã‹ãèª¬æ˜ã—ã¾ã™ï¼ã¾ãŸï¼Œãã®éš›ã«ä»¥ä¸‹ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆãœã²ã“ã¡ã‚‰ã«ã‚‚ã‚¹ã‚¿ãƒ¼ãã ã•ã„ç¬‘ï¼‰

https://github.com/Ningensei848/virtuoso-on-gcp-with-cos

# å‹•ä½œè¦ä»¶

ã¾ãšï¼Œä»¥ä¸‹ã«ç¤ºã™ã‚‚ã®ãŒå¿…è¦ã§ã™ï¼š

- [GCP](https://cloud.google.com/gcp) ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã™ã‚‹ç’°å¢ƒ:
  - `docker`: cf. https://docs.docker.com/get-docker
  - `gcloud`: cf. https://cloud.google.com/sdk/docs/install
  - `gsutil`: cf. https://cloud.google.com/storage/docs/gsutil_install

GCP ã¸ã®ç™»éŒ²ç­‰ã«ã¤ã„ã¦ã¯[å…ˆè¡Œäº‹ä¾‹ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹](https://qiita.com/mirkohm/items/30991fec120541888acd#gcpã«ç™»éŒ²)ã®ã§ãã¡ã‚‰ã«è­²ã‚Šã¾ã™ï¼å¾Œè€…ã«ã¤ã„ã¦ã¯ï¼Œåˆ©ç”¨ã—ã¦ã„ã‚‹ OS ã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ãŒç•°ãªã‚‹ãŸã‚ï¼Œ**ã“ã®è¨˜äº‹å†…ã§å…·ä½“çš„ãªæ–¹æ³•ã«ã¯è§¦ã‚Œã¾ã›ã‚“**ï¼ãã‚Œãã‚Œã® URL ã‹ã‚‰èª¬æ˜ã‚’èª­ã‚“ã§**å„è‡ªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„**ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã ã‘ã§ã‚ã‚Œã°ï¼Œã“ã¡ã‚‰ã‚‚ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã ã‘ã§æ¸ˆã‚€ã¨æ€ã‚ã‚Œã¾ã™ï¼‰ï¼

:::message
`gsutil` ã«ã¤ã„ã¦ã¯ï¼Œ`gcloud` ã‚’æ¨™æº–çš„ãªæ–¹æ³•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸéš›ã«é™„å±ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ï¼› `docker` â†’ `gcloud`ï¼ˆâ†’ `gsutil`ï¼‰ã®é †ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã—ã¦ãã ã•ã„
:::

# æ¦‚è¦

ã¯ã˜ã‚ã«ï¼Œå¿…è¦ãªã‚‚ã®ã‚’æƒãˆãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ `git clone` ã—ã¦ãã ã•ã„ï¼š

`git clone https://github.com/Ningensei848/virtuoso-on-gcp-with-cos.git`

https://github.com/Ningensei848/virtuoso-on-gcp-with-cos

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å…ƒã«ã™ã‚Œã°ï¼Œä»¥ä¸‹ã®ï¼”ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚„ã‚ŠãŸã„ã“ã¨ãŒå®Ÿç¾ã—ã¾ã™ï¼š

1. è¨­å®šé …ç›®ã‚’æ›¸ãæ›ãˆã‚‹ã€€ â† ã€€æœ€é‡è¦ï¼ï¼
2. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã« Virtuoso ã‚³ãƒ³ãƒ†ãƒŠã‚’å»ºã¦ï¼ŒRDF ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹
3. _virtuoso.db_ ã‚’ GCS ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
4. GCE ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹

è¨­å®šãŒã†ã¾ãæ©Ÿèƒ½ã—ã¦ã„ã‚Œã°ï¼Œä½œæˆã•ã‚ŒãŸ GCE ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè‡ªå‹•èµ·å‹•ã—ï¼Œã‚ãªãŸãŒè¨­å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ _https_ ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ï¼

# Step 1. è¨­å®šé …ç›®ã‚’æ›¸ãæ›ãˆã‚‹

ã¾ãšï¼Œ`.env.example` ã‚’é–‹ã„ã¦ãã ã•ã„ï¼ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ï¼Œä»¥é™ã®æ‰‹é †ã§ã‚‚ä½¿ã†è¨­å®šãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ï¼ã—ã‹ã—ï¼Œã“ã®ã¾ã¾ã§ã¯ä½¿ãˆã¾ã›ã‚“ï¼ã‚ãªãŸã®ç’°å¢ƒã«ç½®ãæ›ãˆã¦æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼
ã¾ãŸï¼Œæ›¸ãç›´ã—ãŸå¾Œã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ `.env` ã«ãƒªãƒãƒ¼ãƒ ã—ã¦ãã ã•ã„

è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã«ã‚ãŸã£ã¦ GCP å´ã§ã‚„ã‚‰ã­ã°ãªã‚‰ãªã„ã“ã¨ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼š

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- é™çš„å¤–éƒ¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®äºˆç´„
- ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç¢ºä¿
- [DNS](https://www.nic.ad.jp/ja/newsletter/No22/080.html) ã®è¨­å®š

::::details è©³ç´°ã‚’ã¿ã‚‹

ã€ˆ**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ**ã€‰ã«ã¤ã„ã¦ã¯ï¼ŒGCP ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç™»éŒ²ã—ãŸéš›ã«ï¼Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã¸ç§»è¡Œã™ã‚‹ã¨ãã«ä½œæˆã—ãŸã‚‚ã®ã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã—ï¼Œæ–°ãŸã«ä½œã£ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼ä½•ã§ã‚ã‚Œï¼ŒGCP ä¸Šã§å‹•ã‹ã™æ±ã‚†ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯ï¼Œã“ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã¨ã„ã†æ‹¬ã‚Šã®ä¸­ã§å‹•ä½œã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ï¼ˆã®ã§ï¼Œãªã«ã‚’ã™ã‚‹ã«ã‚‚å¿…è¦ãªæƒ…å ±ã§ã™ï¼‰

ã€ˆ**é™çš„å¤–éƒ¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®äºˆç´„**ã€‰ã«ã¤ã„ã¦ã¯ï¼Œ[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address)ã—ã¦ãã ã•ã„ï¼ã„ã¾ã¾ã§ GCP ã«è§¦ã‚ŒãŸã“ã¨ãŒãªã‘ã‚Œã° "é™çš„å¤–éƒ¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’äºˆç´„ã—ã¦ã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ–°ã—ã„ VM ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚Šå½“ã¦" ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†

:::message alert
å¤–éƒ¨ IP ã‚’äºˆç´„ã™ã‚‹ã¨ï¼Œãã®æ™‚ç‚¹ã§èª²é‡‘ãŒç™ºç”Ÿã—ã¾ã™ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç¨¼åƒæ™‚ã«ã¯ $0.004/hï¼Œæœªä½¿ç”¨æ™‚ã«ã¯ $0.010/h ã»ã©ï¼‰ï¼ãŸã ã—ã“ã‚Œã¯åˆå¹´åº¦ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®æ ã‚’åœ§è¿«ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆä¸€ãƒ¶æœˆã‚ãŸã‚Šï¼“ãƒ‰ãƒ«ã»ã©ã«ãªã‚‹è¨ˆç®—ï¼‰
:::

ã€ˆ**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç¢ºä¿**ã€‰ã«ã¤ã„ã¦ï¼Œ[freenom](https://www.freenom.com) ã‚’ä½¿ãˆã°ã„ã„ã¨ã„ã†è©±ã‚‚ã‚ã‚Šã¾ã™ãŒï¼Œã“ã“ã¯æ•¢ãˆã¦ [Cloud Domains](https://cloud.google.com/domains/docs/overview) ã‚’æ¨ã—ã¦ãŠãã¾ã™ï¼ã“ã‚Œã¯ï¼Œ[Google Domains](https://domains.google) ã¨ã—ã¦ç‹¬ç«‹ã—ã¦ã„ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ï¼ŒGCP ä¸Šã§ã‚‚çµ±åˆã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®ã§ã™ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ã¨æ”¯æ‰•ã„ãŒãƒ©ã‚¯ã«ãªã£ãŸï¼‰ï¼

ã‚ãªãŸã ã‘ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥æ‰‹ã—ãŸã‚‰ï¼Œæ¬¡ã¯ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«å…¥åŠ›ã™ã‚‹ã¨ç”»é¢é·ç§»ï¼ˆã„ã‚ã‚†ã‚‹åå‰è§£æ±ºï¼‰ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã€ˆ**DNS ã‚’è¨­å®š**ã€‰ã—ã¾ã™ï¼ã“ã‚Œã‚‚ã¾ãŸãŠã™ã™ã‚ãªã®ã¯ [Cloud DNS](https://cloud.google.com/dns) ã§ã™ï¼ãŒï¼Œä½•ã§ã‚ã‚Œ DNS ã‚µãƒ¼ãƒã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ï¼ŒA ãƒ¬ã‚³ãƒ¼ãƒ‰ã«äºˆç´„æ¸ˆã¿é™çš„ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ï¼DNS ã‚µãƒ¼ãƒ“ã‚¹ã®ä»•æ§˜ã«ã‚ˆã£ã¦ã¾ã¡ã¾ã¡ã§ã™ãŒï¼Œå®Ÿéš›ã«ãƒ‰ãƒ¡ã‚¤ãƒ³è§£æ±ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã«ä¸€æ—¥ç¨‹åº¦å¾…ã¤å¿…è¦ãŒã‚ã‚‹å ´åˆã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ï¼ˆãªãŠ Cloud DNS ãªã‚‰é…ãã¨ã‚‚ 300 ç§’ç¨‹åº¦ã§ã™ï¼‰

:::message
ã™ã¹ã¦ã‚’ GCP ä¸Šã§å®Œçµã§ãã‚‹ã“ã¨ã¯ï¼Œãã®ä»–ã®æœ€å®‰å€¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¶™ãæ¥ãã™ã‚‹ã‚³ã‚¹ãƒˆã‚’è£œã£ã¦ä½™ã‚Šã‚ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™
:::

::::

ã“ã“ã¾ã§ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ï¼Œ`.env.example` ã‚’ç·¨é›†ã—ï¼Œ**`.env` ã«ãƒªãƒãƒ¼ãƒ ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„**ï¼

:::details å„ç¨®ã®å¤‰æ•°ã«ã¤ã„ã¦ã‚‚ã£ã¨çŸ¥ã‚‹

å¿…é ˆé …ç›®:

- `USERNAME`: ãƒ¦ãƒ¼ã‚¶å
- `USER_EMAIL`: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (for letsencrypt)
- `SERVER_NAME`: å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³å (e.g. your-doma.in)
- `GCP_PROJECT_NAME`: GCP ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
- `GCE_*`: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é–¢ã™ã‚‹ãŠå¥½ã¿è¨­å®š
- `GCS_BUCKET_NAME`: GCS ã«ä½œæˆã—ãŸã„ãƒã‚±ãƒƒãƒˆã®åå‰

ä»»æ„é …ç›®:

- `Parameters_NumberOfBuffers` & `Parameters_MaxDirtyBuffers`: virtuoso performance tuning
- `TOKEN_LINE`: enable notification cf. https://notify-bot.line.me

:::

# Step 2. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã« Virtuoso ã‚³ãƒ³ãƒ†ãƒŠã‚’å»ºã¦ï¼ŒRDF ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹

â€»`git clone` ã—ã¦ããŸãƒªãƒã‚¸ãƒˆãƒªã« `data/` ãƒ•ã‚©ãƒ«ãƒ€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼

1. RDF ãƒ‡ãƒ¼ã‚¿ã‚’ `data/` ä»¥ä¸‹ã«å¥½ããªã‚ˆã†ã«é…ç½®ã™ã‚‹
2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ï¼Œ`isql` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’å¾—ã‚‹
3. Virtuoso ã‚³ãƒ³ãƒ†ãƒŠã‚’å»ºã¦ã‚‹
4. virtuoso ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã¦ `virtuoso.db` ã‚’å¾—ã‚‹

## Step 2.1. RDF ãƒ‡ãƒ¼ã‚¿ã‚’ `data/` ä»¥ä¸‹ã«å¥½ããªã‚ˆã†ã«é…ç½®ã™ã‚‹

ã¾ãšã¯ï¼Œ Virtuoso ã§èª­ã¿è¾¼ã¿ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’ `data/` ã«é›†ã‚ã¦ç½®ã„ã¦ãã ã•ã„ï¼åˆã‚ã¯[å…¬é–‹æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æ¢ã—ã¦ãã¦è©¦ã™](https://www.data.go.jp)ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ï¼ã¾ãŸï¼Œã‚‚ã—è‡ªå‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚ŠãŸã„å ´åˆã«ã¯ï¼ŒXML ã‚ˆã‚Šã‚‚ Turtle å½¢å¼ã§è¨˜è¿°ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ï¼

:::message
ç¾çŠ¶ï¼ŒTurtle å½¢å¼ã‹ XML å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«ã¤ã„ã¦ã¯ Virtuoso å´ã®ä»•æ§˜ã§ã™ï¼‰
:::

## Step 2.2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ï¼Œ`isql` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’å¾—ã‚‹

æ¬¡ã«ï¼Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ `isql` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’å–å¾—ã—ã¾ã™ï¼ã“ã‚Œã¯ï¼Œvirtuoso ã«å¯¾ã—ã¦ã©ã“ã«ã©ã®ãƒ‡ãƒ¼ã‚¿ãŒæœ‰ã‚‹ã®ã‹ãƒ»ã©ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã°è‰¯ã„ã®ã‹ã‚’æ•™ãˆã¦ã‚ã’ã‚‹ã‚‚ã®ã§ã™ï¼ãƒ–ãƒ©ã‚¦ã‚¶çµŒç”±ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã«ã¯ã‚ã‚Šã¾ã™ãŒï¼Œã“ã¡ã‚‰ã¯å¤§è¦æ¨¡ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã«ã¯å‘ã„ã¦ã„ãªã„ã®ã§ç´¹ä»‹ã™ã‚‹ã®ã¯æ§ãˆã¾ã™ï¼

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```shell
source .env
docker run --rm -v $(pwd)/data:/data -v $(pwd)/script:/script -u "$(id -u $USERNAME):$(id -g $USERNAME)" python:3.10-alpine python /script/configureSQL.py ttl --origin https://$SERVER_NAME
```

`source .env` ã§æ›¸ãæ›ãˆãŸè¨­å®šé …ç›®ã‚’èª­ã¿è¾¼ã¿ï¼Œã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼ã¾ãŸ `docker run` ã§ã¯ï¼Œãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã—ãŸä¸Šã§ï¼ŒPython ã«ã‚ˆã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ï¼å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¨ï¼Œ`script/` ä»¥ä¸‹ã« _initialLoader.sql_ ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‹ã§ã—ã‚‡ã†ï¼

## Step 2.3. Virtuoso ã‚³ãƒ³ãƒ†ãƒŠã‚’å»ºã¦ã‚‹

`docker-compose` ã‚’åˆ©ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’å»ºã¦ã¾ã™ï¼ã‚‚ã— `docker` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸéš›ã«é™„å±ã—ã¦ã„ãªã‹ã£ãŸå ´åˆã«ã¯ï¼Œé©å®œ[ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://docs.docker.com/compose/install/)ã—ã¦ãã ã•ã„ï¼

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```shell
source .env
docker-compose up -d virtuoso
```

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€å‰ã«ï¼ŒVirtuoso ãŒæœ¬å½“ã«èµ·å‹•ã—ãŸã®ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

```shell
# Check if the virtuoso server is online at port XXXX
docker-compose logs
```

`logs` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ï¼Œç«‹ã¡ä¸Šã’ãŸã‚³ãƒ³ãƒ†ãƒŠãŒç¾åœ¨ã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã®ã‹çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼
ä»¥ä¸‹ã®ã‚ˆã†ã«ï¼Œ"Server online at XXXX" ï¼ˆXXXX ã¯ãƒãƒ¼ãƒˆç•ªå·ï¼‰ã¨ã„ã†è¡¨ç¤ºãŒã‚ã‚Œã°æº–å‚™å®Œäº†ã§ã™ï¼

> virtuoso_container | HH:MM:SS Server online at $PORT_VIRTUOSO_ISQL (pid 1)

## Step 2.4. virtuoso ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã¦ `virtuoso.db` ã‚’å¾—ã‚‹

â€»å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼šhttp://docs.openlinksw.com/virtuoso/rdfperfloading/
http://docs.openlinksw.com/virtuoso/rdfperfloading/

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è¡Œãªã†æœ€å¾Œã®ä½œæ¥­ã¨ã—ã¦ï¼ŒRDF ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã¦ `virtuoso.db` ã‚’å¾—ã¾ã™ï¼å®Ÿã¯ï¼Œã“ã®ä½œæ¥­ã®ãŸã‚ã«å…ˆç¨‹å–å¾—ã—ãŸ _initialLoader.sql_ ãŒå¿…è¦ãªã®ã§ã—ãŸï¼

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```shell
source .env
nohup docker exec -i virtuoso_container isql $PORT_VIRTUOSO_ISQL -U dba -P $PASSWORD_VIRTUOSO < ./script/initialLoader.sql &
```

:::details ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ãªã«ã‹
ã“ã“ã§ï¼Œ`nohup $@ &` ã¨ã¯ï¼Œ`$@` ã«ç›¸å½“ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã¤ç¾åœ¨ã®æ¥ç¶šçŠ¶æ…‹ã¨ã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã›ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ï¼ãªãœã“ã®ã‚ˆã†ã«ã™ã‚‹ã‹ã¨ã„ã†ã¨ï¼Œ`$@` ã«ç›¸å½“ã™ã‚‹ **`docker exec ~` ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«çµæ§‹ãªæ™‚é–“ãŒã‹ã‹ã‚‹**ï¼ˆã‹ã‚‰ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚„ã‚ŠãŸã„ï¼‰ã‹ã‚‰ã¨ã„ã†ç†ç”±ãŒä¸€ã¤ã¨ï¼Œã‚‚ã†ä¸€ã¤ã¯ **`nohup.out` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«ç¾åœ¨ã®é€²æ—ãŒè¨˜éŒ²ã•ã‚Œã‚‹**ã‹ã‚‰ã¨ã„ã†ç†ç”±ãŒã‚ã‚Šã¾ã™ï¼
:::

ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã«ï¼Œã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `nohup.out` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ virtuoso ã«ã‚ˆã‚‹**ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ãŸéš›ã«ã¯ï¼Œã“ã® `nohup.out` ã®ä¸€ç•ªæœ€å¾Œã« "_initialLoader.sql completed_" ã¨ã„ã†è¡¨ç¤ºãŒå‡ºåŠ›**ã•ã‚Œã¾ã™ï¼

ã“ã®æ–‡å­—åˆ—ãŒç¢ºèªã§ããŸã‚‰ï¼Œæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„ï¼

# Step 3. _virtuoso.db_ ã‚’ GCS ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

:::details GCS ã¨ã¯ãªã«ã‹
[GCS](https://cloud.google.com/storage) (Google Cloud Storage) ã¯ï¼ŒåŒã˜ã GCP ä¸Šã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ï¼GCP ã«ãŠã‘ã‚‹ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ï¼ŒGCE ã«ãŠã‘ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚ˆã†ã«ï¼ŒGCS ã«ã¯ã€Œãƒã‚±ãƒƒãƒˆã€ã¨ã„ã†å˜ä½ãŒã‚ã‚Šã¾ã™ï¼ã“ã®ãƒã‚±ãƒƒãƒˆã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã—ã¦ï¼Œãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç­‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼
ã¾ã ãƒã‚±ãƒƒãƒˆã‚’æŒã£ã¦ã„ãªã„å ´åˆã«ã¯ï¼Œæ–°ãŸã«ä½œæˆã—ã¾ã™ï¼`gsutil` ã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§ä½œæˆã™ã‚‹å ´åˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```shell
source .env
gsutil mb -p $GCE_PROJECT_NAME gs://$GCS_BUCKET_NAME
```

:::

GCS ã®ãƒã‚±ãƒƒãƒˆã«ï¼Œ_virtuoso.db_ ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ã™ãªã‚ã¡ï¼Œãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸Šã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ï¼

```shell
source .env
gsutil cp ./.virtuoso/virtuoso.db gs://$GCS_BUCKET_NAME
```

# Step 4. GCE ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹

æœ€å¾Œã«ï¼Œã“ã‚Œã¾ã§è¨˜è¿°ãƒ»ä½œæˆã—ãŸããŸã‚‚ã®ã‚’ GCE ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼ä»¥ä¸‹ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã¯ `create` ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã‚ã‚Šã¾ã™ãŒï¼Œå¼•æ•°ã®ä¸­ã« `startup-script` ã¨ã„ã†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚“ã§ãŠã‚Šï¼Œã“ã‚Œã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚ŒãŸå¾Œã«**è‡ªå‹•ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèµ°ã‚Šï¼Œã‚µãƒ¼ãƒä¸Šã«å¿…è¦ãªã‚ã‚Œã“ã‚Œã‚’å±•é–‹ã—ã¦ãã‚Œã‚‹ä»•çµ„ã¿**ã«ãªã£ã¦ã„ã¾ã™ï¼

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```shell
source .env
gcloud compute instances create $GCE_CREATE_ARGS
```

:::details $GCE_CREATE_ARGS ã®ä¸­èº«ã‚’çŸ¥ã‚ŠãŸã„

`.env` ã‚’ç·¨é›†ã™ã‚‹éš›ã«ãƒãƒ©ãƒƒã¨è¦‹ãˆãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼Œ**GCE_CREATE_ARGS** ã®ä¸­èº«ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```shell
GCE_CREATE_ARGS="$GCE_INSTANCE_NAME \
 --project $GCE_PROJECT_NAME \
 --zone $GCE_ZONE \
 --machine-type $GCE_MACHINE_TYPE \
 --tags $GCE_TAGS \
 --create-disk $GCE_CREATE_DISK \
 --metadata-from-file user-data=$PWD/gcp/cloud-config.yml,NGINX_CONFIG=$PWD/nginx/default.conf.template,DOTENV=$PWD/.env,COMPOSE_FILE=$PWD/docker-compose.yml,startup-script=$PWD/gcp/startup.sh \
 --metadata google-logging-enabled=true,cos-metrics-enabled=true,USERNAME=$USERNAME \
 --address $GCE_STATIC_IP_ADDRESS \
 --shielded-secure-boot \
 --shielded-vtpm \
 --shielded-integrity-monitoring"
```

å¼•æ•°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸€ã¤ã« `metadata-from-file` ãŒã‚ã‚‹ã®ãŒã‚ã‹ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã“ã«ä¸ãˆãŸå¤‰æ•°ã«ã‚ˆã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ GCE ä¸Šã«ã€Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦æ¸¡ã—ï¼Œ`startup-script` ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ _gcp/startup.sh_ ã«è¨˜è¿°ã•ã‚ŒãŸå‡¦ç†ã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…éƒ¨ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã‚‹ä»•çµ„ã¿ã§ã™ï¼

:::

:::message
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…éƒ¨ã§ã‚‚ `gsutil` ã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦ GCS ã¨ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’å–ã£ã¦ã„ã‚‹é–¢ä¿‚ä¸Šï¼Œäºˆç´„ã—ãŸé™çš„ IP ã§**å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¾ã§ã®æ™‚é–“ã¯ `virtuoso.db` ã®ãƒ‡ãƒ¼ã‚¿é‡ã«ä¾å­˜**ã—ã¦ã„ã¾ã™ï¼ã“ã®å‡¦ç†ã ã‘ã¯ãƒ‡ãƒ¼ã‚¿ã®å¤§ãã•ã«ã‚ˆã£ã¦æ™‚é–“ãŒå–ã‚‰ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼Œã”äº†æ‰¿ãã ã•ã„ï¼
:::

:::details Tips: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•æ™‚ã®ãƒ­ã‚°ã‚’è¦‹ãŸã„

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ï¼ˆåœæ­¢çŠ¶æ…‹ã‹ã‚‰ï¼‰èµ·å‹•ã™ã‚‹ãŸã³ã«ï¼Œ`startup.sh` ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèµ°ã£ã¦ã„ã¾ã™ï¼ã“ã®å®Ÿè¡Œãƒ­ã‚°ã¯ï¼Œä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ç¢ºèªã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ï¼

```shell
source .env
# ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§æ¥ç¶šã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
# 1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« ssh æ¥ç¶šã™ã‚‹
gcloud compute ssh $GCE_INSTANCE_NAME --zone $GCE_ZONE
# 2. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§å®Ÿè¡Œã™ã‚‹
sudo journalctl -u google-startup-scripts.service
```

â€»é–²è¦§çŠ¶æ…‹ã‹ã‚‰æŠœã‘å‡ºã™ã«ã¯ï¼ŒQ ã‚­ãƒ¼ã‚’æŠ¼ä¸‹ã—ã¦ãã ã•ã„ (_quit_ ã®æ„)

**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæœ¬å½“ã«èµ·å‹•ã§ãã¦ã„ã‚‹ã®ã‹ï¼Ÿ**ï¼ˆã‚ã‚‹ã„ã¯èµ·å‹•ã§ããªã‹ã£ãŸç†ç”±ã¯ä½•ãªã®ã‹ï¼‰ã‚’æ¢ã‚‹éš›ã«ã”æ´»ç”¨ãã ã•ã„ï¼

:::

![ãƒ”ãƒ³ã‚¯è‰²ã®èŠ±æŸã®ä¸­ã«ã€ã€ŒãŠã‚ã§ã¨ã†ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã‚‹ã‚¤ãƒ©ã‚¹ãƒˆ](https://1.bp.blogspot.com/-QqaAp33KiPI/U3WdFej9oYI/AAAAAAAAgmg/l5XUakAdCXk/s800/bouquet_omedetou.png =100x)
_Congratulations !!_

ã“ã‚Œã«ã¦ã™ã¹ã¦ã®å·¥ç¨‹ã¯å®Œäº†ã§ã™ï¼ï¼
GCP ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ ğŸ”

# ã¾ã¨ã‚

[å…ˆè¡Œäº‹ä¾‹](https://megalodon.jp/2021-1214-2256-07/https://qiita.com:443/mirkohm/items/30991fec120541888acd)ã®ã‚¦ã‚£ãƒ¼ã‚¯ãƒ»ãƒã‚¤ãƒ³ãƒˆã§ã‚ã£ãŸã€Œæ™‚é–“çš„ã‚³ã‚¹ãƒˆãŒå¤§ãã™ãã‚‹ã€ã€Œã‚µãƒ¼ãƒã‚ˆãã‚ã‹ã‚‰ã‚“äººã«ã¯é›£ã—ã„ã€ã¨ã„ã†å•é¡Œã‚’ï¼Œ`docker` ã¨ GCP ã®å„ç¨®ã‚³ãƒãƒ³ãƒ‰ã§è§£æ±ºã—ã¾ã—ãŸï¼æœ¬æ¥å¿…è¦ã ã£ãŸå‡¦ç†ã¯ï¼Œ`script/configureSQL.py` ã‚„ã‚‰ `gcp/startup.sh`, `gcp/cloud-config.yml` ã®ä¸­ã«ã™ã¹ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ï¼ã‚‚ã—è‡ªåˆ†ãªã‚Šã«ã‚¢ãƒ¬ãƒ³ã‚¸ã—ãŸã„ã¨ã„ã†è¦æœ›ãŒã‚ã‚Œã°ï¼Œãœã²ãã¡ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¦—ã„ã¦ã¿ã¦ãã ã•ã„ï¼
https://github.com/Ningensei848/virtuoso-on-gcp-with-cos
